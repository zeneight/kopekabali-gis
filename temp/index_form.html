<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Denpasar Walkability</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body, html { margin: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #f8f9fa; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Floating UI */
        .floating-card {
            position: absolute; right: 20px; z-index: 1000;
            background: rgba(255,255,255,0.98); padding: 20px; border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12); width: 300px;
        }
        .filter-card { top: 20px; }
        .legend-card { bottom: 100px; padding: 15px; width: auto; min-width: 150px; }

        /* Tombol Lapor */
        .fab-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            border-radius: 50px; padding: 12px 25px;
            font-weight: bold; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            transition: transform 0.2s;
        }
        .fab-btn:hover { transform: scale(1.05); }

        /* Modal Custom */
        .modal-header { background: #2c3e50; color: white; }
        .btn-close { filter: invert(1); }
    </style>
</head>
<body>

    <div class="floating-card filter-card d-none d-md-block">
        <h6 class="fw-bold mb-3"><i class="fa fa-filter"></i> Filter Wilayah</h6>
        <select id="selKecamatan" class="form-select form-select-sm mb-2" onchange="handleDistrictChange()">
            <option value="all">Semua Kecamatan</option>
        </select>
        <select id="selDesa" class="form-select form-select-sm mb-2" onchange="applyFilter()">
            <option value="all">Semua Desa</option>
        </select>
        <select id="selAuth" class="form-select form-select-sm" onchange="applyFilter()">
            <option value="all">Semua Kewenangan</option>
        </select>
        <div class="text-center mt-2 small text-muted" id="totalCount">Loading...</div>
    </div>

    <button onclick="openReportModal()" class="btn btn-danger fab-btn">
        <i class="fa-solid fa-camera me-1"></i> Lapor Kerusakan
    </button>

    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa fa-edit"></i> Form Laporan Warga</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formLapor">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Masalah Apa?</label>
                            <select class="form-select" id="inpType" required>
                                <option value="" selected disabled>Pilih Kategori...</option>
                                <option value="Trotoar Lubang">Trotoar Berlubang / Rusak</option>
                                <option value="Halangan">Halangan (Tiang/Pohon)</option>
                                <option value="Parkir Liar">Parkir Liar di Trotoar</option>
                                <option value="Minim Fasilitas">Tidak Ada Fasilitas / Gelap</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Deskripsi</label>
                            <textarea class="form-control" id="inpDesc" rows="2" placeholder="Contoh: Lubang cukup dalam di depan toko..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Foto Bukti</label>
                            <input type="file" class="form-control" id="inpPhoto" accept="image/*" required>
                            <div class="form-text text-muted small">Max 2MB. Wajib upload foto.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Lokasi Anda</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fa fa-map-marker-alt text-danger"></i></span>
                                <input type="text" class="form-control bg-light" id="inpCoord" placeholder="Mengambil koordinat..." readonly required>
                            </div>
                            <input type="hidden" id="latVal">
                            <input type="hidden" id="lngVal">
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="btnSubmit">
                                <i class="fa fa-paper-plane"></i> Kirim Laporan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- 1. CONFIG ---
        const SUPABASE_URL = 'https://rlsboveqzkrdcbohxnsi.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_OZYrnFcWViuxtMHo12cLjg_NbhUzdiF';
        const BUCKET_NAME  = 'photos'; // Nama bucket storage yg baru dibuat

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Init Map
        const map = L.map('map', { zoomControl: false }).setView([-8.6500, 115.2167], 13);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        let rawGeoJSON = null; 
        let geoJsonLayer = null; 
        let districtHierarchy = {};
        const layerGroupLaporan = L.layerGroup().addTo(map);

        // --- 2. LOGIC MODAL & UPLOAD ---
        const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));

        function openReportModal() {
            // 1. Buka Modal
            reportModal.show();
            
            // 2. Ambil GPS
            const coordField = document.getElementById('inpCoord');
            coordField.value = "Mencari lokasi...";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        document.getElementById('latVal').value = lat;
                        document.getElementById('lngVal').value = lng;
                        coordField.value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                        coordField.classList.add('is-valid');
                    },
                    (err) => {
                        coordField.value = "Gagal ambil lokasi. Pastikan GPS aktif.";
                        alert("Mohon izinkan akses lokasi browser Anda.");
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                coordField.value = "Browser tidak support GPS.";
            }
        }

        // Handle Submit Form
        document.getElementById('formLapor').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('btnSubmit');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Mengirim...';
            btn.disabled = true;

            try {
                // A. Upload Foto
                const file = document.getElementById('inpPhoto').files[0];
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}.${fileExt}`;
                const filePath = `${fileName}`;

                const { error: uploadError } = await supabaseClient.storage
                    .from(BUCKET_NAME)
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                // Dapat URL Publik
                const { data: { publicUrl } } = supabaseClient.storage
                    .from(BUCKET_NAME)
                    .getPublicUrl(filePath);

                // B. Insert ke Database
                // Kita kirim latitude & longitude sebagai TEXT sesuai setup terakhir kita
                const { error: insertError } = await supabaseClient
                    .from('reports')
                    .insert({
                        report_type: document.getElementById('inpType').value,
                        description: document.getElementById('inpDesc').value,
                        photo_url: publicUrl,
                        latitude: document.getElementById('latVal').value.toString(),
                        longitude: document.getElementById('lngVal').value.toString(),
                        status: 'Baru'
                    });

                if (insertError) throw insertError;

                // C. Sukses!
                reportModal.hide();
                Swal.fire('Terima Kasih!', 'Laporan Anda berhasil dikirim.', 'success');
                document.getElementById('formLapor').reset();
                
                // Refresh Peta Laporan
                layerGroupLaporan.clearLayers();
                initData(); // Reload data

            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'Gagal mengirim laporan: ' + err.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // --- 3. LOAD DATA (SAMA SEPERTI SEBELUMNYA) ---
        async function initData() {
            // Load Jalan
            const { data } = await supabaseClient.from('api_ways_geojson').select('*').single();
            if(data && data.row_to_json) {
                rawGeoJSON = data.row_to_json;
                processHierarchy(rawGeoJSON.features);
                renderMap(rawGeoJSON.features, false);
            }

            // Load Laporan
            const { data: reports } = await supabaseClient.from('api_reports_geojson').select('*').single();
            if(reports && reports.row_to_json && reports.row_to_json.features) {
                L.geoJSON(reports.row_to_json, {
                    pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius:8, fillColor:"#e74c3c", color:"#fff", weight:2, fillOpacity:0.9 }),
                    onEachFeature: (f, l) => {
                        // ... (Copy logika popup cantik Anda yang tadi di sini) ...
                        // Untuk ringkasnya saya pakai popup standar dulu di contoh ini, 
                        // tapi silakan paste popup cantik Anda tadi di sini.
                        const p = f.properties;
                        const dateStr = new Date(p.created_at).toLocaleDateString();
                        const img = p.photo_url ? `<img src="${p.photo_url}" style="width:100%;border-radius:4px;margin-top:5px">` : '';
                        const st = p.nearest_street ? `<br><small class="text-primary"><i class="fa fa-road"></i> ${p.nearest_street}</small>` : '';
                        
                        l.bindPopup(`
                            <b>${p.report_type}</b> <span class="text-muted small">${dateStr}</span>
                            ${st}
                            <hr style="margin:5px 0">
                            ${p.description || ''}
                            ${img}
                        `, { minWidth: 250 });
                    }
                }).addTo(layerGroupLaporan);
            }
        }

        // ... (Functions processHierarchy, handleDistrictChange, applyFilter, renderMap sama persis) ...
        // Agar tidak kepanjangan, pastikan Anda mencopy fungsi-fungsi tersebut dari kode sebelumnya.
        
        // --- HELPER FUNCTIONS DARI KODE LAMA ---
        function processHierarchy(features) {
            const authSet = new Set();
            features.forEach(f => {
                const p = f.properties;
                const dist = p.district_name || 'Lainnya';
                const region = p.region_name || 'Lainnya';
                if (!districtHierarchy[dist]) districtHierarchy[dist] = new Set();
                districtHierarchy[dist].add(region);
                if(p.authority) authSet.add(p.authority);
            });
            const selKec = document.getElementById('selKecamatan');
            Object.keys(districtHierarchy).sort().forEach(d => selKec.add(new Option(d.toUpperCase(), d)));
            const selAuth = document.getElementById('selAuth');
            Array.from(authSet).sort().forEach(a => selAuth.add(new Option(a.toUpperCase(), a)));
        }

        function handleDistrictChange() {
            const selectedDist = document.getElementById('selKecamatan').value;
            const selDesa = document.getElementById('selDesa');
            selDesa.innerHTML = '<option value="all">Semua Desa</option>';
            if (selectedDist !== 'all' && districtHierarchy[selectedDist]) {
                Array.from(districtHierarchy[selectedDist]).sort().forEach(r => selDesa.add(new Option(r, r)));
            }
            applyFilter();
        }

        function applyFilter() {
            if(!rawGeoJSON) return;
            const valKec = document.getElementById('selKecamatan').value;
            const valDesa = document.getElementById('selDesa').value;
            const valAuth = document.getElementById('selAuth').value;
            const filtered = rawGeoJSON.features.filter(f => {
                const p = f.properties;
                const matchKec = (valKec === 'all') || (p.district_name === valKec);
                const matchDesa = (valDesa === 'all') || (p.region_name === valDesa);
                const matchAuth = (valAuth === 'all') || (p.authority === valAuth);
                return matchKec && matchDesa && matchAuth;
            });
            renderMap(filtered, true);
        }

        function renderMap(features, autoZoom = false) {
            if(geoJsonLayer) map.removeLayer(geoJsonLayer);
            document.getElementById('totalCount').innerText = `${features.length} Data`;
            geoJsonLayer = L.geoJSON(features, {
                style: (f) => {
                    const sc = f.properties.walkability_index || 0;
                    const pr = f.properties.total_problems || 0;
                    let c = '#95a5a6';
                    if(pr > 0 && sc <= 0) c = '#e74c3c';
                    else if(sc > 0) c = '#2ecc71';
                    return { color: c, weight: 4, opacity: 0.7 };
                },
                onEachFeature: (f, l) => {
                     // ... (Logic Highlight & Popup Jalan) ...
                     l.on('click', (e) => {
                         L.DomEvent.stopPropagation(e);
                         // Highlight logic simplified for brevity
                         e.target.setStyle({ color: '#00d2ff', weight: 8 });
                     });
                     l.bindPopup(`<b>${f.properties.street_name}</b>`);
                }
            }).addTo(map);
            if(autoZoom && features.length > 0) map.fitBounds(geoJsonLayer.getBounds());
        }

        initData();
    </script>
</body>
</html>