<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Denpasar Walkability</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        body, html { margin: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        .info-card {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            width: 300px; background: rgba(255,255,255,0.95);
            padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        .dot-green { background: #2ecc71; }
        .dot-red { background: #e74c3c; }
        .dot-gray { background: #95a5a6; }

        .fab-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            border-radius: 50px; padding: 12px 25px;
            font-weight: bold; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }
    </style>
</head>
<body>

    <div class="info-card d-none d-md-block">
        <h5 class="fw-bold"><i class="fa-solid fa-person-walking"></i> Koalisi Pejalan Kaki</h5>
        <p class="text-muted small">Peta kondisi trotoar & jalan Kota Denpasar.</p>
        <hr>
        <h6 class="fw-bold small">Legenda Jalan</h6>
        <div class="legend-item"><span class="dot dot-green"></span> Ramah (Fasilitas > Masalah)</div>
        <div class="legend-item"><span class="dot dot-red"></span> Tidak Ramah (Banyak Masalah)</div>
        <div class="legend-item"><span class="dot dot-gray"></span> Netral / Belum Ada Laporan</div>
    </div>

    <a href="#" id="btnLaporUtama" target="_blank" class="btn btn-danger fab-btn">
        <i class="fa-solid fa-camera"></i> Lapor Kerusakan
    </a>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // --- 1. KONFIGURASI (ISI DATA ANDA) ---
        const SUPABASE_URL = 'https://rlsboveqzkrdcbohxnsi.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_OZYrnFcWViuxtMHo12cLjg_NbhUzdiF'; 
        
        // Link NocoDB (Update ini nanti setelah Anda membuat Form NocoDB)
        // Sementara biarkan '#', tombol tetap bisa diklik tapi tidak kemana-mana
        let NOCODB_FORM_URL = '#'; 

        // Update Link Tombol Utama
        const btnLapor = document.getElementById('btnLaporUtama');
        if(btnLapor) btnLapor.href = NOCODB_FORM_URL;

        // --- FIX: Inisialisasi Client yang Benar ---
        // Menggunakan 'supabase' (bukan _supabase)
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. Init Peta ---
        const map = L.map('map').setView([-8.6500, 115.2167], 13);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        // --- 3. Load Data Jalan ---
        async function loadRoads() {
            const { data, error } = await supabaseClient.from('api_ways_geojson').select('*').single();
            
            if (error) {
                console.error('Error loading roads:', error);
                return;
            }
            if (!data || !data.row_to_json) return;

            L.geoJSON(data.row_to_json, {
                style: function(feature) {
                    const score = feature.properties.walkability_index || 0;
                    const problems = feature.properties.total_problems || 0;
                    
                    let color = '#95a5a6'; // Abu (Netral)
                    if (problems > 0 && score <= 0) color = '#e74c3c'; // Merah
                    else if (score > 0) color = '#2ecc71'; // Hijau

                    return { color: color, weight: 4, opacity: 0.8 };
                },
                onEachFeature: function(feature, layer) {
                    const p = feature.properties;
                    layer.bindPopup(`
                        <strong>${p.street_name || 'Jalan Tanpa Nama'}</strong><br>
                        <hr style="margin:5px 0">
                        <small>Masalah: <b>${p.total_problems}</b></small> | 
                        <small>Fasilitas: <b>${p.total_amenities}</b></small>
                        <div class="mt-2">
                            <a href="${NOCODB_FORM_URL}" target="_blank" class="btn btn-sm btn-outline-primary w-100">Lapor di sini</a>
                        </div>
                    `);
                }
            }).addTo(map);
        }

        // --- 4. Load Laporan ---
        async function loadReports() {
            const { data, error } = await supabaseClient.from('api_reports_geojson').select('*').single();
            
            if (error) return console.error('Error loading reports:', error);
            
            // PENGAMAN 1: Cek apakah data ada
            if (!data || !data.row_to_json) return;

            const geojson = data.row_to_json;

            // PENGAMAN 2: Cek apakah features null (karena tabel kosong)
            // Jika features null, kita ubah jadi array kosong [] agar Leaflet tidak error
            if (!geojson.features) geojson.features = [];

            L.geoJSON(geojson, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 6, fillColor: "#e74c3c", color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
                    });
                },
                onEachFeature: function(feature, layer) {
                    const p = feature.properties;
                    const img = p.photo_url ? `<img src="${p.photo_url}" style="width:100%; margin-top:5px; border-radius:4px">` : '';
                    layer.bindPopup(`<b>${p.report_type}</b><br>${p.description || ''}${img}`);
                }
            }).addTo(map);
        }

        // Jalankan
        loadRoads();
        loadReports();
    </script>
</body>
</html>